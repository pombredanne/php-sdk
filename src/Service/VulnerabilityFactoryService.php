<?php
/**
 * VulnDB PHP SDK
 *
 * @copyright 2015 Anthon Pang
 *
 * @license http://opensource.org/licenses/MIT MIT
 */

namespace VulnDb\Service;

use Symfony\Component\Finder\Finder;
use VulnDb\Vulnerability;

/**
 * Vulnerability Factory Service
 *
 * {@internal
 *     Use this service to interact with individual vulnerabilities from the database.
 * }}
 *
 * @author Anthon Pang <anthon.pang@gmail.com>
 */
class VulnerabilityFactoryService
{
    /**
     * Load specific vulnerability at given path
     *
     * @param string $file
     *
     * @return \VulnDb\Vulnerability
     */
    public function createFromFile($file)
    {
        if (! file_exists($file)) {
            return;
        }

        $data = json_decode(file_get_contents($file), true);

        if (! $data) {
            return;
        }

        $data['filename'] = basename($file);

        return new Vulnerability($data);
    }

    /**
     * Load specific vulnerability by its id
     *
     * @param integer $id
     *
     * @return \VulnDb\Vulnerability
     */
    public function createFromId($id)
    {
        $file = $this->getFileForId($id);

        if (! $file) {
            return;
        }

        return $this->createFromFile($file);
    }

    /**
     * Determine path to vulnerability data
     *
     * @param integer $id
     *
     * @return string|false
     */
    private function getFileForId($id)
    {
        $jsonDataPath = __DIR__ . '/../../data/db';

        $finder = new Finder();
        $finder->files()->in($jsonDataPath)->name((int) $id . '-*.json');

        foreach ($finder as $file) {
            return $file;
        }
    }
}
